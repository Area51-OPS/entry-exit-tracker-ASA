<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Entry/Exit Tracker</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
	/* Consolidated styles to avoid duplicates and stray braces */
	:root {
	  --bg-dark: #3c3c3c;
	  --panel: rgba(0, 30, 60, 0.9);
	  --accent: #0b66d1;
	  --accent-hover: #0e7ff3;
	  --button-dark: #2f2f2f;
	  --text-on-dark: #ffffff;
	  --input-bg: #ffffff;
	  --input-text: #000000;
	}

	html, body {
	  height: 100%;
	  margin: 0;
	}

	body {
	  font-family: Arial, sans-serif;
	  padding: 20px;
	  background-color: var(--bg-dark);
	  color: var(--text-on-dark);
	}

	.blue-screen {
	  background-color: var(--panel);
	  color: var(--text-on-dark);
	  padding: 30px;
	  border-radius: 8px;
	  margin-bottom: 16px;
	}

	.button-group {
	  display: flex;
	  gap: 10px;
	  flex-wrap: wrap;
	  margin-top: 20px;
	}

	.button-group button {
	  flex: 1 1 30%;
	  padding: 12px;
	  font-size: 16px;
	  border: none;
	  border-radius: 6px;
	  background-color: var(--accent);
	  color: var(--text-on-dark);
	  font-weight: 700;
	  cursor: pointer;
	  transition: background-color 0.2s ease;
	}

	.button-group button:hover {
	  background-color: var(--accent-hover);
	}

	.button-group button.secondary {
	  background-color: var(--button-dark);
	}

	input[type="text"] {
	  display: block;
	  margin: 10px 0;
	  padding: 10px;
	  font-size: 16px;
	  width: 100%;
	  max-width: 400px;
	  border-radius: 4px;
	  border: 1px solid #ccc;
	  background-color: var(--input-bg);
	  color: var(--input-text);
	  box-sizing: border-box;
	}

	#timeOutput {
	  font-weight: bold;
	  margin: 10px 0;
	  color: var(--text-on-dark);
	}

	#exportBtnContainer {
	  display: none;
	  margin-top: 20px;
	  max-width: 420px;
	}

	#exportBtnContainer button {
	  background-color: var(--button-dark);
	  color: #fff;
	  border: none;
	  padding: 10px 14px;
	  margin-right: 8px;
	  border-radius: 6px;
	  font-weight: 700;
	  cursor: pointer;
	}

	#exportBtnContainer button:hover {
	  background-color: var(--accent-hover);
	}

	/* Logs container style */
	#logsTableContainer {
	  max-height: 400px;
	  overflow-y: auto;
	  background: #fff;
	  color: #000;
	  padding: 10px;
	  border-radius: 8px;
	}

	table {
	  width: 100%;
	  border-collapse: collapse;
	  text-align: left;
	}

	table th, table td {
	  padding: 6px;
	  border: 1px solid #ddd;
	}
  </style>
</head>
<body>

  <div id="screen1" class="blue-screen">
	<h2>Select Category</h2>
	<div class="button-group">
	  <button onclick="selectCategory('Student')">1. Student</button>
	  <button onclick="selectCategory('Staff')">2. Staff</button>
	  <button onclick="selectCategory('Management')">3. Management</button>
	</div>
  </div>

  <div id="screen1-5" class="blue-screen" style="display: none;">
	<h2>Select Staff Type</h2>
	<div class="button-group">
	  <button onclick="selectStaffType('Teaching')">Teaching Staff</button>
	  <button onclick="selectStaffType('Non-Teaching')">Non-Teaching Staff</button>
	  <button onclick="goBackToScreen1()">Back</button>
	</div>
  </div>

  <div id="screen2" class="blue-screen" style="display: none;">
	<h2 id="screen2-title">Select Movement</h2>
	<div class="button-group">
	  <button onclick="selectMovement('Coming')">Coming</button>
	  <button onclick="selectMovement('Going')">Going</button>
	  <button onclick="goBackToStaffOrMain()">Back</button>
	</div>
  </div>

  <div id="screen3" class="blue-screen" style="display: none;">
	<h2 id="screen3-title">Movement Log</h2>
	<input type="text" id="nameInput" placeholder="Enter Name" oninput="onNameChanged()" />
	<input type="text" id="classInput" placeholder="Enter Department" />
	<div id="timeOutput"></div>
	<div class="button-group">
	  <button id="logEntryBtn" onclick="logEntry()" disabled>Log Entry</button>
	  <button onclick="goBackToScreen2()">Back</button>
	</div>
  </div>

  <div id="exportBtnContainer" style="display: none;">
	<button onclick="exportToExcel()">Export to Excel</button>
	<button onclick="viewLogs()">View Logs</button>
  </div>

  <div id="screenLogs" class="blue-screen" style="display: none;">
	<h2>Movement Logs</h2>
	<div id="logsTableContainer"></div>

	<div class="button-group" style="margin-top: 20px;">
	  <button id="printBtn" onclick="printLogs()" style="display:none;">Print</button>
	  <button onclick="goBackFromLogs()">Back</button>
	</div>
  </div>

<script>
/* -------------- START OF JS CODE -------------- */
const DATA_KEY = 'movementTrackerData';
const DATE_KEY = 'movementTrackerDate';

let dataEntries = [];
const nameToClassMap = {};
let autoID = 1;
let currentExportDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

window.currentCategory = '';
window.currentStaffType = '';
window.currentMovement = '';

function getFormattedDateTime() {
  const now = new Date();
  const options = {
	year: 'numeric',
	month: '2-digit',
	day: '2-digit',
	hour: '2-digit',
	minute: '2-digit',
	second: '2-digit',
	hour12: true,
  };
  return now.toLocaleString('en-US', options);
}

function saveData() {
  try {
	localStorage.setItem(DATA_KEY, JSON.stringify(dataEntries));
  } catch (e) {
	console.error('Failed to save data to localStorage', e);
  }
}

function clearLogs(startNewDay = false) {
  if (startNewDay || confirm("Are you sure you want to clear all logs? This action is irreversible unless you have exported the data.")) {
	dataEntries = [];
	autoID = 1;
	localStorage.removeItem(DATA_KEY);

	if (startNewDay) {
	  const today = new Date().toISOString().split('T')[0];
	  localStorage.setItem(DATE_KEY, today);
	  currentExportDate = today;
	  location.reload();
	} else {
	  alert('Logs cleared successfully.');
	}
  }
}

function initializeTracker() {
  const savedData = localStorage.getItem(DATA_KEY);
  const savedDate = localStorage.getItem(DATE_KEY);
  const today = new Date().toISOString().split('T')[0];

  if (savedData && savedDate && savedDate !== today) {
	const parsedData = JSON.parse(savedData);
	dataEntries = parsedData;
	currentExportDate = savedDate;
	alert(`A new day has begun! Please export the logs from ${savedDate} before logging new entries.`);
	document.getElementById('exportBtnContainer').style.display = 'block';
  } else if (savedData && savedDate === today) {
	const parsedData = JSON.parse(savedData);
	dataEntries = parsedData;
	const maxId = dataEntries.reduce((max, entry) => Math.max(max, entry.ID || 0), 0);
	autoID = maxId + 1;
	console.log(`Continuing log for ${today}. ${dataEntries.length} entries loaded.`);
	currentExportDate = today;
  } else {
	localStorage.setItem(DATE_KEY, today);
	currentExportDate = today;
  }
}

initializeTracker();

function selectCategory(category) {
  window.currentCategory = category;
  const exportContainer = document.getElementById('exportBtnContainer');

  if (category === 'Staff' || category === 'Management') {
	exportContainer.style.display = 'block';
  } else {
	exportContainer.style.display = 'none';
  }

  if (category === 'Staff') {
	document.getElementById('screen1').style.display = 'none';
	document.getElementById('screen1-5').style.display = 'block';
  } else {
	document.getElementById('screen1').style.display = 'none';
	document.getElementById('screen2').style.display = 'block';
  }
}

function selectStaffType(type) {
  window.currentStaffType = type;
  document.getElementById('screen1-5').style.display = 'none';
  document.getElementById('screen2').style.display = 'block';
}

function selectMovement(movement) {
  window.currentMovement = movement;
  document.getElementById('screen2').style.display = 'none';
  document.getElementById('screen3').style.display = 'block';
  document.getElementById('screen3-title').textContent = `${movement} Log`;
  updateCurrentTime();

  const classInput = document.getElementById('classInput');
  if (window.currentCategory === 'Student') {
	classInput.placeholder = 'Enter Class';
  } else if (window.currentCategory === 'Staff') {
	classInput.placeholder = window.currentStaffType === 'Teaching' ? 'Enter Class' : 'Enter Department';
  } else if (window.currentCategory === 'Management') {
	classInput.placeholder = 'Enter Position';
  }

  document.getElementById('nameInput').value = '';
  classInput.value = '';
  classInput.disabled = false;
  document.getElementById('logEntryBtn').disabled = true;
}

function goBackToScreen1() {
  document.getElementById('screen1-5').style.display = 'none';
  document.getElementById('screen1').style.display = 'block';
}

function goBackToStaffOrMain() {
  document.getElementById('screen2').style.display = 'none';
  if (window.currentCategory === 'Staff') {
	document.getElementById('screen1-5').style.display = 'block';
  } else {
	document.getElementById('screen1').style.display = 'block';
  }
}

function goBackToScreen2() {
  document.getElementById('screen3').style.display = 'none';
  document.getElementById('screen2').style.display = 'block';
}

function logEntry() {
  const name = document.getElementById('nameInput').value.trim();
  const classVal = document.getElementById('classInput').value.trim();
  const time = document.getElementById('timeOutput').textContent.trim();

  const today = new Date().toISOString().split('T')[0];
  if (currentExportDate !== today) {
	return alert("Cannot log new entry. Please export the previous day's logs first.");
  }

  if (!name) return alert('Please enter a name before logging.');

  const key = name.toLowerCase();
  let finalClassVal = classVal || nameToClassMap[key];

  if (!finalClassVal && !nameToClassMap[key]) {
	return alert('Please enter class, department, or position for this new name.');
  }

  if (!nameToClassMap[key] && finalClassVal) {
	nameToClassMap[key] = finalClassVal;
  }

  const category = window.currentCategory || 'Student';
  const staffType = window.currentStaffType || '';
  const movement = window.currentMovement || 'Entered';

  let categoryField = 'Department';
  if (category === 'Student' || (category === 'Staff' && staffType === 'Teaching')) {
	categoryField = 'Class';
  } else if (category === 'Management') {
	categoryField = 'Position';
  }

  const entry = {
	ID: autoID++,
	Name: name,
	Category: category,
	StaffType: staffType,
	Movement: movement,
	Time: time || getFormattedDateTime()
  };
  // attach the appropriate field
  entry[categoryField] = nameToClassMap[key] || finalClassVal || '';

  dataEntries.push(entry);
  saveData();

  document.getElementById('nameInput').value = '';
  document.getElementById('classInput').value = '';
  document.getElementById('classInput').disabled = false;
  document.getElementById('timeOutput').textContent = '';
  document.getElementById('logEntryBtn').disabled = true;

  alert('Entry logged successfully.');
}

function viewLogs() {
  const logsContainer = document.getElementById('logsTableContainer');
  document.getElementById('screen2').style.display = 'none';
  document.getElementById('screenLogs').style.display = 'block';

  if (dataEntries.length === 0) {
	logsContainer.innerHTML = '<p>No entries logged yet.</p>';
	return;
  }

  let html = '<table>';
  html += '<tr><th>ID</th><th>Name</th><th>Category</th><th>Staff Type</th><th>Class/Dept/Pos</th><th>Movement</th><th>Time</th></tr>';

  for (const e of dataEntries) {
	const info = e.Class || e.Department || e.Position || '';
	html += `<tr>
	  <td>${e.ID}</td>
	  <td>${e.Name}</td>
	  <td>${e.Category}</td>
	  <td>${e.StaffType || '-'}</td>
	  <td>${info}</td>
	  <td>${e.Movement}</td>
	  <td>${e.Time}</td>
	</tr>`;
  }

  html += '</table>';
  logsContainer.innerHTML = html;
}

function goBackFromLogs() {
  document.getElementById('screenLogs').style.display = 'none';
  document.getElementById('screen2').style.display = 'block';
}

function onNameChanged() {
  const name = document.getElementById('nameInput').value.trim().toLowerCase();
  const classInput = document.getElementById('classInput');
  const logButton = document.getElementById('logEntryBtn');

  if (name && nameToClassMap[name]) {
	classInput.value = nameToClassMap[name];
	classInput.disabled = true;
	updateCurrentTime();
	logButton.disabled = false;
  } else if (name) {
	classInput.disabled = false;
	updateCurrentTime();
	logButton.disabled = false;
  } else {
	classInput.value = '';
	classInput.disabled = false;
	document.getElementById('timeOutput').textContent = '';
	logButton.disabled = true;
  }
}

function updateCurrentTime() {
  document.getElementById('timeOutput').textContent = getFormattedDateTime();
}

function exportToExcel() {
  if (dataEntries.length === 0) {
	if (localStorage.getItem(DATA_KEY)) {
	  clearLogs(true);
	  return;
	}
	return alert('No data to export.');
  }

  const studentEntries = dataEntries.filter(e => e.Category === 'Student');
  const staffEntries = dataEntries.filter(e => e.Category === 'Staff');
  const managementEntries = dataEntries.filter(e => e.Category === 'Management');

  const workbook = XLSX.utils.book_new();

  if (studentEntries.length) XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(studentEntries), 'Students');
  if (staffEntries.length) XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(staffEntries), 'Staff');
  if (managementEntries.length) XLSX.utils.book_append_sheet(workbook, XLSX.utils.json_to_sheet(managementEntries), 'Management');

  const filename = `Movement_Logs_${currentExportDate}.xlsx`;
  XLSX.writeFile(workbook, filename);
  alert(`Excel file saved: ${filename}`);

  // If exporting old-day data, clear and start fresh
  const today = new Date().toISOString().split('T')[0];
  if (currentExportDate !== today) {
	clearLogs(true);
  }
}

/* -------------- END OF JS CODE -------------- */
</script>

</body>
</html>
