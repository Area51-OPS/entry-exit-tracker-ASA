<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Entry/Exit Tracker</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  :root {
    --bg-dark: #3c3c3c;
    --panel: rgba(0, 30, 60, 0.9);
    --accent: #0b66d1;
    --accent-hover: #0e7ff3;
    --button-dark: #2f2f2f;
    --text-on-dark: #ffffff;
    --input-bg: #ffffff;
    --input-text: #000000;
  }

  html, body {
    height: 100%;
    margin: 0;
  }

  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background-color: var(--bg-dark);
    color: var(--text-on-dark);
  }

  .blue-screen {
    background-color: var(--panel);
    color: var(--text-on-dark);
    padding: 30px;
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
  }

  .button-group button {
    flex: 1 1 30%;
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background-color: var(--accent);
    color: var(--text-on-dark);
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .button-group button.logs-btn {
    flex: 1 1 100%;
    margin-top: 10px;
    background-color: var(--button-dark);
  }

  .button-group button:hover {
    background-color: var(--accent-hover);
  }

  .button-group button.secondary {
    background-color: var(--button-dark);
  }

  input[type="text"], input[type="password"] {
    display: block;
    margin: 10px 0;
    padding: 10px;
    font-size: 16px;
    width: 100%;
    max-width: 400px;
    border-radius: 4px;
    border: 1px solid #ccc;
    background-color: var(--input-bg);
    color: var(--input-text);
    box-sizing: border-box;
  }

  #timeOutput {
    font-weight: bold;
    margin: 10px 0;
    color: var(--text-on-dark);
  }

  .password-control {
    margin-top: 20px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
  }

  .password-control button {
    background-color: var(--button-dark);
    flex: 1 1 100%;
  }

  .logs-control-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .logs-control-buttons button {
    flex: 1;
    padding: 12px;
  }

  #logsTableContainer {
    max-height: 400px;
    overflow-y: auto;
    background: #fff;
    color: #000;
    padding: 10px;
    border-radius: 8px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    text-align: left;
  }

  table th, table td {
    padding: 6px;
    border: 1px solid #ddd;
    color: var(--input-text);
  }
</style>
</head>
<body>

<!-- Screen 1: Category Selection -->
<div id="screen1" class="blue-screen">
  <h2>Select Category</h2>
  <div class="button-group">
    <button onclick="selectCategory('Student')">1. Student</button>
    <button onclick="selectCategory('Staff')">2. Staff</button>
    <button onclick="selectCategory('Management')">3. Management</button>
  </div>
</div>

<!-- Screen 1.5: Staff Type -->
<div id="screen1-5" class="blue-screen" style="display: none;">
  <h2>Select Staff Type</h2>
  <div class="button-group">
    <button onclick="selectStaffType('Teaching')">Teaching Staff</button>
    <button onclick="selectStaffType('Non-Teaching')">Non-Teaching Staff</button>
    <button onclick="goBackToScreen1()">Back</button>
  </div>
</div>

<!-- Screen 2: Movement Selection -->
<div id="screen2" class="blue-screen" style="display: none;">
  <h2 id="screen2-title">Select Movement</h2>
  <div class="button-group">
    <button onclick="selectMovement('Arrival')">Arrival</button>
    <button onclick="selectMovement('Departure')">Departure</button>
    <button onclick="goBackToStaffOrMain()">Back</button>
  </div>
  <button id="logsControlBtn" onclick="showLogsControlScreen()" class="logs-btn" style="display: none;">View/Export Logs</button>
</div>

<!-- Screen 3: Log Entry -->
<div id="screen3" class="blue-screen" style="display: none;">
  <h2 id="screen3-title">Movement Log</h2>
  <input type="text" id="nameInput" placeholder="Enter Name" oninput="onNameChanged()" />
  <input type="text" id="classInput" placeholder="Enter Department" />
  <div id="timeOutput"></div>
  <div class="button-group">
    <button id="logEntryBtn" onclick="logEntry()" disabled>Log Entry</button>
    <button onclick="goBackToScreen2()">Back</button>
  </div>
</div>

<!-- Screen: Logs Control -->
<div id="screenLogsControl" class="blue-screen" style="display: none;">
  <h2>Log Access Controls</h2>

  <div class="logs-control-buttons">
    <button id="exportBtn" onclick="exportToExcel()" disabled>Export to Excel</button>
    <button id="viewLogsBtn" onclick="viewLogs()" disabled>View Logs Table</button>
  </div>

  <div class="password-control">
    <h4>ðŸ”’ Access Password</h4>
    <input type="password" id="logPasswordInput" placeholder="Enter Password to Access Logs" />
    <div class="button-group">
      <button onclick="checkAndGrantLogAccess()">Access Logs</button>
      <button onclick="changePasswordFlow()" class="secondary" id="setChangePasswordBtn">Set/Change Password</button>
    </div>
  </div>

  <div class="button-group">
    <button onclick="goBackToScreen2()">Back</button>
  </div>
</div>

<!-- Screen: View Logs Table -->
<div id="screenLogs" class="blue-screen" style="display: none;">
  <h2>Movement Logs</h2>
  <div id="logsTableContainer"></div>

  <div class="button-group" style="margin-top: 20px;">
    <button id="printBtn" onclick="printLogs()" style="display:none;">Print</button>
    <button onclick="goBackFromLogs()">Back</button>
  </div>
</div>

<script>
/* ----------------- JS Code ----------------- */
const DATA_KEY = 'movementTrackerData';
const DATE_KEY = 'movementTrackerDate';
const PASSWORD_KEY = 'logAccessPassword';

let dataEntries = [];
const nameToClassMap = {};
let autoID = 1;
let currentExportDate = new Date().toISOString().split('T')[0];
let logAccessGranted = false;

window.currentCategory = '';
window.currentStaffType = '';
window.currentMovement = '';

function toggleAccessButtons(enable) {
  document.getElementById('exportBtn').disabled = !enable;
  document.getElementById('viewLogsBtn').disabled = !enable;
}

function getFormattedDateTime() {
  const now = new Date();
  const options = { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true };
  return now.toLocaleString('en-US', options);
}

function saveData() { localStorage.setItem(DATA_KEY, JSON.stringify(dataEntries)); }

function clearLogs(startNewDay=false) {
  if (startNewDay || confirm("Are you sure you want to clear all logs?")) {
    dataEntries = []; autoID = 1; localStorage.removeItem(DATA_KEY);
    if (startNewDay) { localStorage.setItem(DATE_KEY, new Date().toISOString().split('T')[0]); location.reload(); }
  }
}

function initializeTracker() {
  const savedData = localStorage.getItem(DATA_KEY);
  const savedDate = localStorage.getItem(DATE_KEY);
  const today = new Date().toISOString().split('T')[0];

  if (localStorage.getItem(PASSWORD_KEY)) localStorage.removeItem(PASSWORD_KEY);

  if (savedData && savedDate && savedDate !== today) {
    dataEntries = JSON.parse(savedData);
    currentExportDate = savedDate;
    alert(`A new day has begun! Please export the logs from ${savedDate} first.`);
  } else if (savedData && savedDate === today) {
    dataEntries = JSON.parse(savedData);
    autoID = Math.max(...dataEntries.map(e => e.ID || 0)) + 1;
    currentExportDate = today;
  } else localStorage.setItem(DATE_KEY, today);

  document.getElementById('logsControlBtn').style.display = 'none';
  toggleAccessButtons(false);
  logAccessGranted = false;
  updatePasswordUI();
}

initializeTracker();

/* ðŸ”’ Password functions */
function updatePasswordUI() {
  const setChangeBtn = document.getElementById('setChangePasswordBtn');
  const pwdInput = document.getElementById('logPasswordInput');
  const isSet = !!localStorage.getItem(PASSWORD_KEY);
  if (setChangeBtn) setChangeBtn.textContent = isSet ? "Change Password" : "Set Password";
  if (pwdInput) {
    pwdInput.placeholder = logAccessGranted ? "Access Granted" : (isSet ? "Enter Password to Access Logs" : "Set a Password (4+ chars)");
    pwdInput.disabled = logAccessGranted;
    pwdInput.type = logAccessGranted ? 'text' : 'password';
  }
}

function checkAndGrantLogAccess() {
  const stored = localStorage.getItem(PASSWORD_KEY);
  const input = (document.getElementById('logPasswordInput').value || '').trim();
  if (logAccessGranted) return true;
  if (!stored) { alert("No password set. Access granted for now."); logAccessGranted=true; toggleAccessButtons(true); updatePasswordUI(); return true; }
  if (input === stored) { logAccessGranted=true; toggleAccessButtons(true); updatePasswordUI(); alert("Access Granted."); return true; }
  alert("Incorrect Password."); document.getElementById('logPasswordInput').value=''; document.getElementById('logPasswordInput').focus(); return false;
}

function changePasswordFlow() {
  const stored = localStorage.getItem(PASSWORD_KEY);
  if (stored) { const curr = prompt("Enter current password:"); if(curr!==stored) return alert("Incorrect current password."); }
  const newPwd = prompt("Enter new password (4+ chars):"); if(!newPwd || newPwd.trim().length<4) return alert("Must be 4+ chars.");
  localStorage.setItem(PASSWORD_KEY,newPwd.trim()); logAccessGranted=false; toggleAccessButtons(false); document.getElementById('logPasswordInput').value=''; alert(stored?"Password changed successfully.":"Password set successfully."); updatePasswordUI();
}

/* Screen navigation */
function selectCategory(category) {
  window.currentCategory=category;
  const logsBtn = document.getElementById('logsControlBtn');
  if(category==='Student'||category==='Staff') logsBtn.style.display='none'; else logsBtn.style.display='block';
  if(category==='Student') { document.getElementById('screen1').style.display='none'; document.getElementById('screen2').style.display='block'; }
  else if(category==='Staff') { document.getElementById('screen1').style.display='none'; document.getElementById('screen1-5').style.display='block'; }
  else if(category==='Management') { document.getElementById('screen1').style.display='none'; document.getElementById('screen2').style.display='block'; }
}

function selectStaffType(type){ window.currentStaffType=type; document.getElementById('screen1-5').style.display='none'; document.getElementById('screen2').style.display='block'; }
function showLogsControlScreen(){ if(window.currentCategory==='Student') return alert("Access Denied"); document.getElementById('screen1').style.display='none'; document.getElementById('screen1-5').style.display='none'; document.getElementById('screen2').style.display='none'; document.getElementById('screen3').style.display='none'; document.getElementById('screenLogs').style.display='none'; document.getElementById('screenLogsControl').style.display='block'; toggleAccessButtons(logAccessGranted); updatePasswordUI(); if(!logAccessGranted) document.getElementById('logPasswordInput').focus(); }
function selectMovement(movement){ window.currentMovement=movement; document.getElementById('screen2').style.display='none'; document.getElementById('screen3').style.display='block'; document.getElementById('screen3-title').textContent=`${movement} Log`; updateCurrentTime(); const ci=document.getElementById('classInput'); ci.placeholder=window.currentCategory==='Student'?'Enter Class':window.currentCategory==='Staff'? (window.currentStaffType==='Teaching'?'Enter Class':'Enter Department'):'Enter Position'; document.getElementById('nameInput').value=''; ci.value=''; ci.disabled=false; document.getElementById('logEntryBtn').disabled=true; }
function goBackToScreen1(){ document.getElementById('screen1-5').style.display='none'; document.getElementById('screen1').style.display='block'; document.getElementById('logsControlBtn').style.display='none'; }
function goBackToStaffOrMain(){ document.getElementById('screen2').style.display='none'; document.getElementById('screenLogsControl').style.display='none'; if(window.currentCategory==='Staff') document.getElementById('screen1-5').style.display='block'; else document.getElementById('screen1').style.display='block'; document.getElementById('logsControlBtn').style.display='none'; }
function goBackToScreen2(){ document.getElementById('screen3').style.display='none'; document.getElementById('screenLogsControl').style.display='none'; document.getElementById('screen2').style.display='block'; }

/* Logging */
function logEntry(){
  const name=document.getElementById('nameInput').value.trim();
  const classVal=document.getElementById('classInput').value.trim();
  const time=document.getElementById('timeOutput').textContent.trim();
  const today=new Date().toISOString().split('T')[0];
  if(currentExportDate!==today) return alert("Export previous day's logs first.");
  if(!name) return alert('Enter name.');
  const key=name.toLowerCase();
  let finalClassVal=classVal||nameToClassMap[key];
  if(!finalClassVal && !nameToClassMap[key]) return alert('Enter class/department/position for new name.');
  if(!nameToClassMap[key] && finalClassVal) nameToClassMap[key]=finalClassVal;
  const category=window.currentCategory||'Student';
  const staffType=window.currentStaffType||'';
  const movement=window.currentMovement||'Entered';
  let categoryField='Department';
  if(category==='Student'||(category==='Staff' && staffType==='Teaching')) categoryField='Class';
  else if(category==='Management') categoryField='Position';
  const entry={ ID:autoID++, Name:name, Category:category, StaffType:staffType, Movement:movement, Time:time||getFormattedDateTime() };
  entry[categoryField]=nameToClassMap[key]||finalClassVal||'';
  dataEntries.push(entry);
  saveData();
  if(category!=='Student') document.getElementById('logsControlBtn').style.display='block';
  document.getElementById('nameInput').value=''; document.getElementById('classInput').value=''; document.getElementById('classInput').disabled=false; document.getElementById('timeOutput').textContent=''; document.getElementById('logEntryBtn').disabled=true;
  alert('Entry logged successfully.');
}

/* Logs viewing/export */
function viewLogs(){
  if(window.currentCategory==='Student') return alert("Access Denied.");
  document.getElementById('screenLogsControl').style.display='none';
  const logsContainer=document.getElementById('logsTableContainer');
  document.getElementById('screenLogs').style.display='block';
  if(dataEntries.length===0){ logsContainer.innerHTML='<p>No entries logged yet.</p>'; return; }
  let html='<table><tr><th>ID</th><th>Name</th><th>Category</th><th>Staff Type</th><th>Class/Dept/Pos</th><th>Movement</th><th>Time</th></tr>';
  for(const e of dataEntries){ const info=e.Class||e.Department||e.Position||''; html+=`<tr><td>${e.ID}</td><td>${e.Name}</td><td>${e.Category}</td><td>${e.StaffType||'-'}</td><td>${info}</td><td>${e.Movement}</td><td>${e.Time}</td></tr>`; }
  html+='</table>'; logsContainer.innerHTML=html;
}
function goBackFromLogs(){ document.getElementById('screenLogs').style.display='none'; document.getElementById('screenLogsControl').style.display='block'; updatePasswordUI(); }

function onNameChanged(){ const name=document.getElementById('nameInput').value.trim().toLowerCase(); const ci=document.getElementById('classInput'); const logBtn=document.getElementById('logEntryBtn'); if(name && nameToClassMap[name]){ ci.value=nameToClassMap[name]; ci.disabled=true; updateCurrentTime(); logBtn.disabled=false; } else if(name){ ci.disabled=false; updateCurrentTime(); logBtn.disabled=false; } else{ ci.value=''; ci.disabled=false; document.getElementById('timeOutput').textContent=''; logBtn.disabled=true; } }
function updateCurrentTime(){ document.getElementById('timeOutput').textContent=getFormattedDateTime(); }

function exportToExcel(){
  if(window.currentCategory==='Student') return alert("Access Denied.");
  if(dataEntries.length===0){ if(localStorage.getItem(DATA_KEY)){ clearLogs(true); return; } return alert('No data to export.'); }
  const studentEntries=dataEntries.filter(e=>e.Category==='Student');
  const staffEntries=dataEntries.filter(e=>e.Category==='Staff');
  const managementEntries=dataEntries.filter(e=>e.Category==='Management');
  const wb=XLSX.utils.book_new();
  if(studentEntries.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(studentEntries),'Students');
  if(staffEntries.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(staffEntries),'Staff');
  if(managementEntries.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(managementEntries),'Management');
  const filename=`Movement_Logs_${currentExportDate}.xlsx`;
  XLSX.writeFile(wb,filename); alert(`Excel file saved: ${filename}`);
  const today=new Date().toISOString().split('T')[0];
  if(currentExportDate!==today) clearLogs(true);
}
</script>

</body>
</html>
